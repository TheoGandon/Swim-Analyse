<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Évolution des séances de natation</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h1, h2 { margin-bottom: 0.4rem; }
    p { margin-top: 0.2rem; }
    .chart-block { margin: 40px 0; }
    canvas { width: 100%; max-width: 1000px; }
    #sessionsTable { margin-top: 20px; border-collapse: collapse; width: 100%; font-size: 0.9rem; }
    #sessionsTable th, #sessionsTable td { border: 1px solid #ccc; padding: 4px 6px; text-align: right; }
    #sessionsTable th { background: #f2f2f2; }
    #sessionsTable td:first-child, #sessionsTable th:first-child { text-align: left; }
  </style>
</head>
<body>

<h1>Évolution des séances de natation</h1>
<p>Importer un ou plusieurs fichiers CSV générés par ta montre (avec intervalles). Le script calculera une séance globale par fichier.</p>

<input type="file" id="fileInput" accept=".csv" multiple>
<p id="status"></p>

<h2>Résumé des séances</h2>
<table id="sessionsTable"></table>

<div class="chart-block"><canvas id="chartDistance"></canvas></div>
<div class="chart-block"><canvas id="chartDuration"></canvas></div>
<div class="chart-block"><canvas id="chartPace"></canvas></div>
<div class="chart-block"><canvas id="chartHR"></canvas></div>
<div class="chart-block"><canvas id="chartSwolf"></canvas></div>

<script>
let chartDistance, chartDuration, chartPace, chartHR, chartSwolf;

document.getElementById("fileInput").addEventListener("change", handleFiles);

function handleFiles(e) {
  const files = [...e.target.files];
  if (!files.length) return;

  document.getElementById("status").textContent = "Lecture des fichiers...";
  const sessions = [];
  let processed = 0;

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = evt => {
      const text = evt.target.result;
      const session = parseSwimIntervalsCSV(text, file.name);
      if (session) sessions.push(session);
      processed++;
      if (processed === files.length) finalize(sessions);
    };
    reader.readAsText(file);
  });
}

function finalize(sessions) {
  if (!sessions.length) {
    document.getElementById("status").textContent = "Aucune séance exploitable.";
    return;
  }

  sessions.sort((a, b) => a.dateObj - b.dateObj);
  document.getElementById("status").textContent = "Séances lues : " + sessions.length;

  renderTable(sessions);
  renderCharts(sessions);
}

function parseSwimIntervalsCSV(text, filename) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return null;

  const delimiter = lines[0].includes(";") ? ";" : ",";
  const headers = lines[0].split(delimiter).map(h => h.trim());
  const dataLines = lines.slice(1).filter(l => l.trim().length > 0);

  const idxDistance = headers.indexOf("Distance");
  const idxDuration = headers.indexOf("Durée");
  const idxHR = headers.indexOf("Fréquence cardiaque moyenne");
  const idxSwolf = headers.indexOf("SWOLF moyen");

  if (idxDistance === -1 || idxDuration === -1) return null;

  let totalDist = 0;
  let totalTime = 0;
  let hrWeighted = 0;
  let swolfSum = 0;
  let swolfCount = 0;

  for (const line of dataLines) {
    const cols = line.split(delimiter);

    const dist = parseFloat(cols[idxDistance].replace(",", "."));
    if (!isNaN(dist)) totalDist += dist;

    const durSec = parseDuration(cols[idxDuration]);
    if (!isNaN(durSec)) totalTime += durSec;

    if (idxHR >= 0) {
      const hr = parseFloat(cols[idxHR].replace(",", "."));
      if (!isNaN(hr) && !isNaN(durSec)) hrWeighted += hr * durSec;
    }

    if (idxSwolf >= 0) {
      const s = parseFloat(cols[idxSwolf].replace(",", "."));
      if (!isNaN(s)) {
        swolfSum += s;
        swolfCount++;
      }
    }
  }

  if (totalDist === 0 || totalTime === 0) return null;

  const hrAvg = hrWeighted > 0 ? hrWeighted / totalTime : NaN;
  const swolfAvg = swolfCount > 0 ? swolfSum / swolfCount : NaN;
  const paceSec100 = (totalTime / totalDist) * 100;

  const dateInfo = extractDate(filename);

  return {
    fileName: filename,
    dateObj: dateInfo.dateObj,
    dateLabel: dateInfo.label,
    distKm: totalDist / 1000,
    durationMin: totalTime / 60,
    paceSec100,
    hrAvg,
    swolfAvg
  };
}

function extractDate(name) {
  const m = name.match(/(\d{2})-(\d{2})-(\d{4})/);
  const dd = m[1], mm = m[2], yyyy = m[3];
  return {
    dateObj: new Date(yyyy, mm - 1, dd),
    label: `${yyyy}-${mm}-${dd}`
  };
}

function parseDuration(str) {
  if (!str) return NaN;
  const parts = str.split(":");
  if (parts.length === 2) return parseFloat(parts[0]) * 60 + parseFloat(parts[1].replace(",", "."));
  if (parts.length === 3) return parseFloat(parts[0]) * 3600 + parseFloat(parts[1]) * 60 + parseFloat(parts[2]);
  return NaN;
}

function renderTable(sessions) {
  let html = `
    <tr>
      <th>Date</th><th>Fichier</th><th>Distance (km)</th>
      <th>Durée (min)</th><th>Allure (sec/100m)</th>
      <th>FC moy (bpm)</th><th>SWOLF moy</th>
    </tr>
  `;
  sessions.forEach(s => {
    html += `
      <tr>
        <td>${s.dateLabel}</td>
        <td>${s.fileName}</td>
        <td>${s.distKm.toFixed(2)}</td>
        <td>${s.durationMin.toFixed(1)}</td>
        <td>${s.paceSec100.toFixed(1)}</td>
        <td>${isNaN(s.hrAvg) ? "" : s.hrAvg.toFixed(0)}</td>
        <td>${isNaN(s.swolfAvg) ? "" : s.swolfAvg.toFixed(1)}</td>
      </tr>
    `;
  });
  document.getElementById("sessionsTable").innerHTML = html;
}

function renderCharts(sessions) {
  const labels = sessions.map(s => s.dateLabel);
  chartDistance = drawChart(chartDistance, "chartDistance", "Distance (km)", labels, sessions.map(s => s.distKm));
  chartDuration = drawChart(chartDuration, "chartDuration", "Durée (min)", labels, sessions.map(s => s.durationMin));
  chartPace = drawChart(chartPace, "chartPace", "Allure (sec/100m)", labels, sessions.map(s => s.paceSec100));
  chartHR = drawChart(chartHR, "chartHR", "FC moyenne (bpm)", labels, sessions.map(s => s.hrAvg));
  chartSwolf = drawChart(chartSwolf, "chartSwolf", "SWOLF moyen", labels, sessions.map(s => s.swolfAvg));
}

function drawChart(instance, canvasId, label, labels, values) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  if (instance) instance.destroy();
  return new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label, data: values }]
    },
    options: { responsive: true }
  });
}
</script>

</body>
</html>
